<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>CVE-2024-53375 TP-Link Archer router series Authenticated RCE :: Thotty</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="This article discloses the discovery, exploitation and responsible disclosure of an authenticated command injection zero-day vulnerability in the TP-Link Archer router series" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="/posts/cve-2024-53375/" />






  
  
  
  
  
  <link rel="stylesheet" href="/styles.css">







  <link rel="shortcut icon" href="/img/theme-colors/orange.png">
  <link rel="apple-touch-icon" href="/img/theme-colors/orange.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="Thottysploity" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="CVE-2024-53375 TP-Link Archer router series Authenticated RCE">
<meta property="og:description" content="This article discloses the discovery, exploitation and responsible disclosure of an authenticated command injection zero-day vulnerability in the TP-Link Archer router series" />
<meta property="og:url" content="/posts/cve-2024-53375/" />
<meta property="og:site_name" content="Thotty" />

  
    <meta property="og:image" content="/img/favicon/orange.png">
  

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2024-11-25 00:00:00 &#43;0000 UTC" />












</head>
<body class="orange">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    ThottySploity
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/writeups">Write-ups</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/about" >About</a></li>
        
      
        
          <li><a href="/writeups" >Write-ups</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="/posts/cve-2024-53375/">CVE-2024-53375 TP-Link Archer router series Authenticated RCE</a>
  </h1>
  <div class="post-meta"><time class="post-date">2024-11-25</time><span class="post-author">Thottysploity</span></div>

  
  


  

  <div class="post-content"><div>
        <h1 id="1-introduction"><code>1</code> Introduction<a href="#1-introduction" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>This article shows the research, development, exploitation and responsible disclosure of a zero-day vulnerability in the TP-Link Archer router series. Exploitation of this vulnerability can lead to a full compromise of the affected device. This vulnerability was found in an old firmware of the AXE75 router (2023), this vulnerability is however present in the most recent version of the firmware (November 4th 2024).</p>
<h1 id="2-terminology"><code>2</code> Terminology<a href="#2-terminology" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>This chapter gives some insight into the terms used throughout this article.</p>
<table>
<thead>
<tr>
<th>Term</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Firmware</td>
<td>A type of software that is directly placed onto a piece of hardware during manufacturing, it is like the &ldquo;brains&rdquo; of a device.</td>
</tr>
<tr>
<td>Emulating</td>
<td>Emulating is the process of using one system to mimic or imitate another system so that it can run software or perform tasks as if it were that original system.</td>
</tr>
<tr>
<td>Reverse Engineering</td>
<td>Reverse engineering is the process of taking something apart to understand how it works, often in order to replicate, modify, or improve it.</td>
</tr>
<tr>
<td>Vulnerability</td>
<td>A vulnerability is a weakness or flaw in a system, software, or device that can be exploited by someone.</td>
</tr>
<tr>
<td>squash-fs</td>
<td>SquashFS (Squash File System) is a type of compressed, read-only file system that is often used in Linux environments.</td>
</tr>
<tr>
<td>ubifs</td>
<td>UBIFS (Unsorted Block Image File System) is a file system designed for flash memory devices (like NAND flash memory) in embedded systems.</td>
</tr>
<tr>
<td>kernel</td>
<td>The kernel is the core part of an operating system (OS) that manages the hardware and software of a computer or device.</td>
</tr>
<tr>
<td>daemon</td>
<td>A daemon is a type of program or process that runs in the background of a computer system, rather than being directly interacted with by the user</td>
</tr>
<tr>
<td>shell</td>
<td>A shell is a program that allows users to interact with the operating system using text-based commands.</td>
</tr>
</tbody>
</table>
<h1 id="3-obtaining-the-firmware"><code>3</code> Obtaining the firmware<a href="#3-obtaining-the-firmware" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Getting the firmware for TP-Link routers is a straightforward process. TP-Link makes their firmware publicly available for anyone to download directly from their website. The image below illustrates how to download the firmware for a specific router model:

<img src="/img/firmware_download.png"  alt="Firmware download"  class="center"  style="border-radius: 8px;"    />

</p>
<h1 id="4-reversing-the-firmware"><code>4</code> Reversing the firmware<a href="#4-reversing-the-firmware" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>It is common for vendor firmware to be encrypted, requiring decryption before it can be examined for vulnerabilities. For example, D-Link encrypts their firmware, making analysis difficult. In contrast, TP-Link does not encrypt their firmware, although this could change in the future. While encryption helps protect against malicious actors attempting to reverse-engineer firmware, it also poses a challenge for security researchers working with good intentions.</p>
<h1 id="41-extracting-files-from-the-firmware"><code>4.1</code> Extracting files from the firmware<a href="#41-extracting-files-from-the-firmware" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Firmware is a type of binary that contains other binaries, somewhat like a zip file. It includes a boot image, which holds the necessary files and instructions for starting up the system. This boot image is essential in the boot process because it contains the kernel. In addition to the boot image, the firmware also stores the files required for the device to operate correctly. On smaller devices, the kernel may access filesystems like <code>squash-fs</code> or <code>ubifs</code> to load and manage the system’s files.</p>
<p>The <code>binwalk</code> tool is primarily used to extract information from files and executable code, with its most common use being the extraction of files from firmware. To extract data from a firmware file, the following command is used: <code>binwalk -e firmware.bin</code>, where <code>firmware.bin</code> represents the firmware file. Binwalk will then extract the data and save it in a new folder named after the firmware file. The image below illustrates an example of the types of data that can be extracted from a firmware file:

<img src="/img/binwalk.png"  alt="Binwalk output"  class="center"  style="border-radius: 8px;"    />

</p>
<p>The most notable folder here is the <code>squashfs-root</code> folder. Squashfs holds all the files found on the device when it&rsquo;s running, meaning the <code>squashfs-root</code> folder represents the entire filesystem of the router, including all of its files.

<img src="/img/filesystem_router.png"  alt="Filesystem of the router"  class="center"  style="border-radius: 8px;"    />

</p>
<p>This firmware is for a router, and routers typically provide a web interface for administrative tasks, such as configuring the WiFi password. Because of this, the <code>www</code> folder is a good place to begin exploring. This folder is also found on servers with a web server installed, though it is typically located in <code>/var/</code> on those systems.

<img src="/img/www.png"  alt="www folder content"  class="center"  style="border-radius: 8px;"    />

</p>
<p>Upon opening the <code>www</code> folder, we find three subfolders and one file. The <code>cgi-bin</code> folder stands out here. The Common Gateway Interface (CGI) is an interface that tells the web server how to process data between the server and an application (source: stack-overflow.com). In this firmware, the <code>cgi-bin</code> folder contains just one file:

<img src="/img/luci.png"  alt="luci"  class="center"  style="border-radius: 8px;"    />

</p>
<p>LuCI uses the Lua programming language and organizes the interface into logical components like models and views. This setup improves performance, keeps the installation size small, speeds up runtimes, and makes maintenance easier. Lua is ideal for devices with limited storage space (openwrt).</p>
<p>This firmware stores all the Lua files in the directory <code>/usr/lib/lua/luci</code>. There are 221 <code>.lua</code> files in total, which together provide the full functionality of the router.

<img src="/img/lua_files.png"  alt="luci"  class="center"  style="border-radius: 8px;"    />

</p>
<h1 id="5-emulating-the-firmware"><code>5</code> Emulating the firmware<a href="#5-emulating-the-firmware" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Before we can audit the firmware for vulnerabilities, we need a method to run it. This is typically achieved through one of the following approaches:</p>
<ul>
<li>Using a physical device that hosts the firmware for testing;</li>
<li>Emulating the entire device using the kernel image and filesystem from the firmware;</li>
<li>Partially emulating specific components of the firmware for targeted vulnerability assessment.</li>
</ul>
<p>I opted for the third option because I don&rsquo;t have the physical device, and the second option was causing QEMU to crash. The third option also allowed to only emulate the binary that is responsible for serving the web gateway, which saved some computer resources.</p>
<p><code>Qemu-arm-static</code> has been used to emulate only the web gateway of the TP-Link router. This form of emulation doesn&rsquo;t require the kernel embedded in the firmware but instead utilizes the kernel of the host machine. Routers typically run lightweight HTTP servers; for example, D-Link uses lighttpd, while TP-Link uses uhttpd. Since this firmware is from TP-Link, we thus need to emulate <code>uhttpd</code>.</p>
<p>Firstly, we need to copy the <code>qemu-arm-static</code> binary over into the right target location. The command <code>cp /usr/bin/qemu-arm-static /home/user/archer/_firmware.bin.extracted/squashfs-root/usr/bin</code> copies the qemu-arm-static binary from our /usr/bin/ location into the /usr/bin location of the extracted firmware.

<img src="/img/copy_qemu.png"  alt="Copying Qemu-arm-static"  class="center"  style="border-radius: 8px;"    />

</p>
<h1 id="51-emulating-uhttpd"><code>5.1</code> Emulating uhttpd<a href="#51-emulating-uhttpd" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>To emulate our target: <code>uhttpd</code>, we need to change our root directory. Linux comes pre-installed with the <code>chroot</code> binary. This binary allows a user to change the root directory of the process and of its children. Utilizing the command: <code>sudo chroot . usr/bin/qemu-arm-static /usr/sbin/uhttpd -f -h /www -r Archer_AXE300 -x /cgi-bin -t 120 -T 30 -A 1 -n 3 -R -p 0.0.0.0:80</code> we achieve a couple things:</p>
<ul>
<li>We change the root directory to the local directory (indicated by chroot .);</li>
<li>we start the qemu-arm-static that was copied to the /usr/bin folder;</li>
<li>We start the /usr/sbin/uhttpd binary that is embedded in the firmware;</li>
<li>We start uhttpd in the directory of /www;</li>
<li>We start uhttpd on IP and port: 0.0.0.0:80;

<img src="/img/bus_fail.png"  alt="Ubus failing"  class="center"  style="border-radius: 8px;"    />

</li>
</ul>
<p>The image above indicates that something went wrong. The <code>ubus</code> failed to start. The ubus enables communication between processes running on the router, so lets fix this error message. To fix this error a couple commands need to be given, firstly these two commands:</p>
<ul>
<li><code>sudo mount --bind /dev ./dev</code></li>
<li><code>sudo mount --bind /proc ./proc</code></li>
</ul>
<p>These commands mount the <code>/dev</code> and <code>/proc</code> directories of the host machine to those of the emulated firmware.</p>

<img src="/img/mounting_dev_proc.png"  alt="Mounting the dev and proc folders"  class="center"  style="border-radius: 8px;"    />


<p>Now we need to make sure the <code>ubus</code> daemon is started up and ready to be used. To do this we can enter the device using the <code>chroot</code> binary. To get an interactive shell we need to start <code>/bin/bash</code>, which can be done like so: <code>sudo chroot . bin/bash</code>. Within this interactive shell we actually start the ubus daemon. This can be done with the command <code>ubusd &amp;</code> which starts the ubus deamon in the background.</p>

<img src="/img/starting_ubus.png"  alt="Starting Ubus"  class="center"  style="border-radius: 8px;"    />


<p>Now it displays a different error message, <code>usock: not a directory</code>. This error can be resolved by creating a <code>/var/run</code> directory in the <code>squashfs-root</code> folder. Like so:

<img src="/img/ubus_usock.png"  alt="Creating /var/run folders"  class="center"  style="border-radius: 8px;"    />

</p>
<p>Now when re-issueing the <code>ubusd &amp;</code> command it should start the ubusd without any problem. Once no error has occured we can start the <code>uhttpd</code> again.</p>

<img src="/img/starting_uhttpd.png"  alt="Starting uhttpd"  class="center"  style="border-radius: 8px;"    />


<p>As you can see, there is no error and when we browse to <code>localhost:80</code> we get the following screen:</p>

<img src="/img/tp_browser.png"  alt="TP-Link interface"  class="center"  style="border-radius: 8px;"    />


<p>We now have succesfully emulated the part of the TP-Link router that is responsible for the Web gateway.</p>
<h1 id="6-identifying-vulnerabilities"><code>6</code> Identifying vulnerabilities<a href="#6-identifying-vulnerabilities" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Manually auditing every file on the filesystem is possible but highly inefficient and time-consuming. A more efficient approach to identify Remote Code Execution (RCE) vulnerabilities is to first locate any code capable of executing commands on the underlying operating system.</p>
<p>Once this code is identified, the next step is to trace its usage within the system. These functions are integral to how the firmware performs its tasks. For instance, CGI-BINs may require reverse engineering using a decompiler, while Lua scripts can often be audited simply by reading the code. TP-Link, for example, uses several functions to execute commands on the underlying OS, including:</p>
<ul>
<li>os.execute</li>
<li>subprocess.call</li>
<li>sys.fork_exec</li>
<li>fork_call</li>
</ul>
<p>After identifying these functions, we can begin investigating the mistakes left by the developers. There&rsquo;s no need to manually go through all 200+ files; instead, we can use <code>grep</code> to search through the file contents and filter the results. For instance, to find instances of <code>os.execute</code> in all files, we can use the following command: <code>grep -rni &quot;os.execute&quot;</code>.

<img src="/img/grep_example.png"  alt="grep example"  class="center"  style="border-radius: 8px;"    />

</p>
<p>This command provides a list of all files that use <code>os.execute</code>, along with the line numbers where it&rsquo;s called. The next step is to determine how and where this code is being invoked, to see if we can exploit it. For Remote Code Execution (RCE) to be possible, you must be able to manipulate the variables being passed to the system executor.</p>
<p>This method also lead to the discovery of this vulnerability:

<img src="/img/avira_exploit.png"  alt="avira"  class="center"  style="border-radius: 8px;"    />

</p>
<p>The vulnerability that is highlighted here pertains to the avira.lua file. So what actually is Avira? funny enough Avira is an antivirus software that is tasked with protecting your device against attackers. Now this antivirus can be used to gain <code>root</code> (highest possible access) to the routers underlying operating system.</p>

<img src="/img/avira.png"  alt="avira"  class="center"  style="border-radius: 8px;"    />


<p>Now I don&rsquo;t blame the developers of avira, as a mistake is easily made especially in a file that is over 2000 lines long.</p>
<p>So why is this function vulnerable to a RCE? The answer lies in the <code>ownerId</code> variable. The function declares a local variable of OwnerId which is being filled by the <code>data.ownerId</code> variable. The <code>data</code> variable is being decoded from json from the <code>app_from.data</code> variable. The ownerId variable gets passed to the <code>os.execute</code> function on the last line while not being checked, sanitized or anything. The developers did note a <code>--int</code> comment to indicate that the ownerId is supposed to be an integer but it is just an assumption at this point.</p>

<img src="/img/vuln_func.png"  alt="vulnerable function"  class="center"  style="border-radius: 8px;"    />


<p>The function is named <code>tmp_get_sites</code>. We can use the same trick as with finding references to <code>os.execute</code>. We just change the grep command a bit to the following command: <code>grep -rni &quot;tmp_get_sites&quot;</code>.

<img src="/img/tmp_get_sites.png"  alt="cross-reference function"  class="center"  style="border-radius: 8px;"    />

</p>
<p>We can see that the <code>tmp_get_sites</code> is being used in the file: <code>lib/lua/luci/controller/admin/smart_network</code>. This file is only accessable when a user or attacker is logged in, as indicated by the <code>admin</code> folder.</p>
<p>When opening the smart_networks.lua file we see the following all the way at the bottom. This is how TP-Link made their functions callable:</p>

<img src="/img/smart_network.png"  alt="smart_network endpoint"  class="center"  style="border-radius: 8px;"    />


<p>We need to make the request to <code>/admin/smart_network?form=tmp_avira</code> and the <code>operation</code> needs to be <code>getInsightSites</code> to trigger the vulnerable function. It is an <code>operation</code> because this is how TP-Link has defined it in their code.</p>
<p>Now this operation calls to the function <code>tmp_get_sites</code> this however is not the <code>tmp_get_sites</code> as defined in the <code>avira.lua</code>. This function is re-defined within the smart_network endpoint but it does point to the <code>tmp_get_sites</code> from avira.</p>

<img src="/img/get_insights.png"  alt="get_insight"  class="center"  style="border-radius: 8px;"    />


<p>As we can also see in this function, there is no checking nor sanitization of any kind. The app_from that is parsed here gets directly parsed to the <code>AVIRA:tmp_get_sites</code> function.</p>
<h1 id="7-exploitation"><code>7</code> Exploitation<a href="#7-exploitation" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>We now know it is vulnerable, the next step is actually proving it is vulnerable. The way to do this is to gather all the knowledge we have thus far have obtained. We know we need to call an app_from, we know we need to set certain parameters to exploit and we know we need to authenticate.</p>
<p>I want to give major props to <code>aaronsvk</code> at <code>https://github.com/aaronsvk</code> for already making the authentication part of this exploit code. I did not have to re-invent the wheel and I majorly appreciate that.</p>
<p>The vulnerability can be exploited by placing a payload in the <code>ownerid</code> value. The <code>date</code> is set to the current day, serving no purpose other than preventing a null value for the parameter. The <code>type</code> is set to &ldquo;visit,&rdquo; which is crucial for exploiting this vulnerability. Additionally, both the <code>startIndex</code> and <code>amount</code> are configured to ensure they do not null the parameters in the code. I have tested the exploit without these parameters set, but this would lead to a failed exploit attempt.</p>

<img src="/img/exploit%20code.png"  alt="exploit code"  class="center"  style="border-radius: 8px;"    />


<p>The full exploit code can be found on: <a href="https://github.com/ThottySploity/CVE-2024-53375">https://github.com/ThottySploity/CVE-2024-53375</a></p>
<p>Now what can we actually achieve with this exploit?</p>
<p>Well, we run as <code>root</code>

<img src="/img/root.png"  alt="run as root"  class="center"  style="border-radius: 8px;"    />

</p>
<p>We can dump any file that we like.. want to see <code>/etc/passwd</code> and <code>/etc/shadow</code>:

<img src="/img/passwdshadow.png"  alt="passwdshadow"  class="center"  style="border-radius: 8px;"    />

</p>
<h1 id="8-mitigation"><code>8</code> Mitigation<a href="#8-mitigation" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>The mitigations for this vulnerabilities would be to sanitize the input of <code>ownerId</code>. This can be done using the function <code>tonumber</code> in Lua. This would mitigate any injected text.</p>

<img src="/img/mitigation.png"  alt="mitigation"  class="center"  style="border-radius: 8px;"    />


<h1 id="9-responsible-disclosure"><code>9</code> Responsible Disclosure<a href="#9-responsible-disclosure" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>When finding a zero-day the most responsible action to do is disclose it with the vendor.</p>
<ul>
<li>03.10.2024 - Identified vulnerability</li>
<li>04.10.2024 - Contacted Zero Day Initiative (ZDI)</li>
<li>10.10.2024 - ZDI was not interested in aquiring the vulnerability</li>
<li>10.10.2024 - Contacted TP-Link with information about the vulnerability</li>
<li>12.10.2024 - TP-Link forwarded information to person for analysis</li>
<li>30.10.2024 - Requested CVE-ID from MITRE</li>
<li>08.11.2024 - TP-Link acknowledged vulnerability and provided fixed beta firmware version</li>
<li>23.11.2024 - MITRE reserved CVE-ID 2024-53375</li>
</ul>
<h1 id="10-references"><code>10</code> References<a href="#10-references" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<ul>
<li><a href="https://www.kernel.org/doc/html/latest/filesystems/squashfs.html">https://www.kernel.org/doc/html/latest/filesystems/squashfs.html</a></li>
<li><a href="https://stackoverflow.com/questions/2089271/what-is-common-gateway-interface-cgi#2089297">https://stackoverflow.com/questions/2089271/what-is-common-gateway-interface-cgi#2089297</a></li>
<li><a href="https://openwrt.org/docs/techref/luci">https://openwrt.org/docs/techref/luci</a></li>
</ul>

      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="/posts/cve-2024-53376/">
                <span class="button__icon">←</span>
                <span class="button__text">CVE-2024-53376 CyberPanel Authenticated RCE</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="/posts/lateralmovement/">
                <span class="button__text">How a threat actor moves laterally through a network</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2024 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
